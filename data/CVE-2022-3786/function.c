#include <string.h>
#include <stdio.h>
#include <stdlib.h>

#define LABEL_BUF_SIZE 512

static unsigned char encode_xn_part(const char *in, size_t len) {
    unsigned char sum = 0;
    for (size_t i = 4; i < len; i++) { // Skip "xn--"
        sum += in[i];
    }
    return sum;
}

size_t standard_ossl_a2ulabel(const char *in, char *out, size_t *outlen) {
    char *out_start = out;
    const char *in_start = in;
    size_t in_len = strlen(in), max_out_len = *outlen, actual_out_len = 0;

#define WRITE_CHAR(c) \
    if (actual_out_len++ < max_out_len) { \
        *out++ = c; \
    }

    while(in - in_start < in_len) {
        const char *dot = strchr(in, '.');
        size_t part_len = dot ? dot - in : in_len - (in - in_start);
        if (part_len < 5 || strncmp(in, "xn--", 4) != 0) {
            for(size_t i = 0; i < part_len; i++) {
                WRITE_CHAR(in[i]);
            }
        } else {
            WRITE_CHAR(encode_xn_part(in, part_len));
        }

        in += part_len + 1;
        if (dot) {
            WRITE_CHAR('.');
        }
    }
#undef WRITE_CHAR

    *outlen = out - out_start;
    return actual_out_len;
}

size_t ossl_a2ulabel(const char *in, char *out, size_t *outlen) {
// BEGIN SOLUTION
    char *out_start = out;
    const char *in_start = in;
    size_t in_len = strlen(in), max_out_len = *outlen, actual_out_len = 0;

#define WRITE_CHAR(c) \
    if (actual_out_len++ < max_out_len) { \
        *out++ = c; \
    }

    while(in - in_start < in_len) {
        const char *dot = strchr(in, '.');
        size_t part_len = dot ? dot - in : in_len - (in - in_start);
        if (part_len < 5 || strncmp(in, "xn--", 4) != 0) {
            for(size_t i = 0; i < part_len; i++) {
                WRITE_CHAR(in[i]);
            }
        } else {
            WRITE_CHAR(encode_xn_part(in, part_len));
        }

        in += part_len + 1;
        if (dot) {
            WRITE_CHAR('.');
        }
    }
#undef WRITE_CHAR

    *outlen = out - out_start;
    return actual_out_len;
// END SOLUTION
}

int main() {
    // test the function ossl_a2ulabel

    char in[LABEL_BUF_SIZE];
    char ans[LABEL_BUF_SIZE];
    size_t ans_len = LABEL_BUF_SIZE;
    char out[LABEL_BUF_SIZE];
    size_t out_len = LABEL_BUF_SIZE, out_ret;

    char rand_buf[LABEL_BUF_SIZE];

    for(int i = 0; i < LABEL_BUF_SIZE; i++) {
        rand_buf[i] = rand() % 256;
    }

    strcpy(in, "www.xn--example.com");
    ans_len = LABEL_BUF_SIZE;
    standard_ossl_a2ulabel(in, ans, &ans_len);
    
    // test case 1.1
    memcpy(out, rand_buf, LABEL_BUF_SIZE);
    out_len = LABEL_BUF_SIZE;
    out_ret = ossl_a2ulabel(in, out, &out_len);
    if (out_len != ans_len || out_ret != ans_len || memcmp(out, ans, ans_len) != 0) {
        printf("Test case 1.1 failed\n");
        return 1;
    }


    // test case 1.2
    memcpy(out, rand_buf, LABEL_BUF_SIZE);
    out_len = 5;
    out_ret = ossl_a2ulabel(in, out, &out_len);
    if (out_ret != ans_len || out_len > 5 || memcmp(out, ans, out_len) != 0) {
        printf("Test case 1.2 failed\n");
        return 1;
    }

    // test case 1.3
    memcpy(out, rand_buf, LABEL_BUF_SIZE);
    out_len = 0;
    out_ret = ossl_a2ulabel(in, out, &out_len);
    if (out_ret != ans_len || out_len != 0) {
        printf("Test case 1.3 failed\n");
        return 1;
    }

    strcpy(in, "xn--1.xn--2.xn--.xn--.xn--.xnn-.xn--123.xn--.xn--.xn--");
    ans_len = LABEL_BUF_SIZE;
    standard_ossl_a2ulabel(in, ans, &ans_len);

    // test case 2.1
    memcpy(out, rand_buf, LABEL_BUF_SIZE);
    out_len = LABEL_BUF_SIZE;
    out_ret = ossl_a2ulabel(in, out, &out_len);
    if (out_len != ans_len || out_ret != ans_len || memcmp(out, ans, ans_len) != 0) {
        printf("Test case 2.1 failed\n");
        return 1;
    }

    // test case 2.2
    memcpy(out, rand_buf, LABEL_BUF_SIZE);
    out_len = 10;
    out_ret = ossl_a2ulabel(in, out, &out_len);
    if (out_ret != ans_len || out_len > 10 || memcmp(out, ans, out_len) != 0) {
        printf("Test case 2.2 failed\n");
        return 1;
    }

    // test case 2.3
    memcpy(out, rand_buf, LABEL_BUF_SIZE);
    out_len = 0;
    out_ret = ossl_a2ulabel(in, out, &out_len);
    if (out_ret != ans_len || out_len != 0) {
        printf("Test case 2.3 failed\n");
        return 1;
    }

    printf("All test cases passed\n");
    return 0;    
}
